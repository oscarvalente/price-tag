{"version":3,"file":"page-agent.js","sources":["../page-agent.js"],"sourcesContent":["function buildElementSelection(path, maxElements) {\n    const pathSelection = [];\n    let elemCount = 1;\n    for (let {localName, className, id} of path) {\n        if (maxElements >= elemCount) {\n            const pathElementSelection = className ?\n                `${localName.trim()}.${className.trim().replace(/\\s/g, \".\")}` :\n                id ?\n                    `${localName.trim()}#${id}` :\n                    localName.trim();\n            pathSelection.push(pathElementSelection);\n        } else {\n            break;\n        }\n        elemCount++;\n    }\n    return pathSelection.reverse().join(\" \");\n}\n\nfunction getFaviconPath() {\n    const nodeList = document.getElementsByTagName(\"link\");\n    for (let node of nodeList) {\n        if (node.getAttribute(\"rel\") === \"icon\" || node.getAttribute(\"rel\") === \"shortcut icon\") {\n            return node.getAttribute(\"href\");\n        }\n    }\n    return null;\n}\n\nfunction getFaviconURL() {\n    const faviconPath = getFaviconPath();\n    if (faviconPath) {\n        if (faviconPath.startsWith(location.protocol) || faviconPath.startsWith(\"//\")) {\n            return faviconPath;\n        } else if (faviconPath.startsWith(\"/\")) {\n            return `${location.protocol}//${location.hostname}${faviconPath}`;\n        } else {\n            return `${location.href}/${faviconPath}`;\n        }\n    }\n    return null;\n}\n\nfunction evaluatePriceTag(selection, sendResponse) {\n    const target = document.body.querySelector(selection);\n    const textContent = target ? target.textContent : null;\n    if (textContent) {\n        const textContentMatch = textContent.match(/((?:\\d+[.,])?\\d+(?:[.,]\\d+)?)/);\n        if (textContentMatch) {\n            const [, price] = textContentMatch;\n            sendResponse({\n                status: 1,\n                selection,\n                price,\n                faviconURL: getFaviconURL(),\n                faviconAlt: document.title\n            });\n        } else {\n            sendResponse({status: -2});\n        }\n    } else {\n        sendResponse({status: -1});\n    }\n}\n\nfunction displaySaveConfirmation(elementId, sendResponse) {\n    const extensionOrigin = `chrome-extension://${chrome.runtime.id}`;\n    if (!location.ancestorOrigins.contains(extensionOrigin)) {\n        const modalElement = document.createElement(\"iframe\");\n        if (elementId) {\n            modalElement.setAttribute(\"id\", elementId);\n        }\n\n        // Must be declared at web_accessible_resources in manifest.json\n        modalElement.src = chrome.runtime.getURL(\"views/modal.html\");\n        modalElement.onload = () => {\n            sendResponse({status: 1});\n        };\n\n        modalElement.style.cssText = \"position:fixed;top:0;right:0;display:block;\" +\n            \"width:700px;height:100%;z-index:1000;border:0;margin-top: 200px;\";\n\n        document.body.appendChild(modalElement);\n\n        return true;\n    }\n\n    sendResponse({status: -1});\n\n    return false;\n}\n\nfunction attachEvents() {\n    chrome.runtime.onMessage.addListener(({type, payload = {}}, sender, sendResponse) => {\n        let originalBGColor;\n        let elementToHighlight;\n        let elementToStopHighlight;\n        let confirmationModal;\n        let {originalBackgroundColor} = payload;\n        const {selection, elementId} = payload;\n        switch (type) {\n            case \"RECORD.START\":\n\n                document.body.style.cursor = \"pointer\";\n                window.focus();\n                document.body.onclick = function (event) {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    const {target, path} = event;\n                    const {url} = payload;\n                    const {textContent} = target;\n                    const selection = buildElementSelection(path, 3);\n                    let price = null;\n                    if (!url) {\n                        sendResponse({status: -1});\n                        return;\n                    }\n                    if (textContent) {\n                        const textContentMatch = textContent.match(/((?:\\d+[.,])?\\d+(?:[.,]\\d+)?)/);\n                        if (textContentMatch) {\n                            [, price] = textContentMatch;\n                            sendResponse({\n                                status: 1,\n                                url,\n                                selection,\n                                price,\n                                faviconURL: getFaviconURL(),\n                                faviconAlt: document.title\n                            });\n                        } else {\n                            sendResponse({status: -3});\n                        }\n                    } else {\n                        sendResponse({status: -2});\n                    }\n\n                    target.style.backgroundColor = originalBGColor;\n                    document.body.style.cursor = \"\";\n                    document.body.onclick = null;\n                    document.body.onmouseover = null;\n                };\n\n                document.body.onmouseover = ({target}) => {\n                    target.addEventListener(\"mouseout\", ({target}) => {\n                        target.style.backgroundColor = originalBGColor;\n                        target.removeEventListener(\"mouseout\", target);\n                    });\n                    originalBGColor = target.style.backgroundColor;\n                    target.style.backgroundColor = \"#c9ecfc\";\n                };\n\n                return true;\n            case \"RECORD.CANCEL\":\n                document.body.style.cursor = \"\";\n                document.body.onclick = null;\n                document.body.onmouseover = null;\n\n                sendResponse({});\n                break;\n            case \"AUTO_SAVE.CHECK_STATUS\":\n                if (document.readyState !== \"complete\") {\n                    window.onload = () => {\n                        evaluatePriceTag(selection, sendResponse);\n\n                        window.onload = null;\n                    };\n\n                    return true;\n                } else {\n                    evaluatePriceTag(selection, sendResponse);\n                    return false;\n                }\n            case \"PRICE_UPDATE.CHECK_STATUS\":\n                if (document.readyState !== \"complete\") {\n                    window.onload = () => {\n                        evaluatePriceTag(selection, sendResponse);\n\n                        window.onload = null;\n                    };\n\n                    return true;\n                } else {\n                    evaluatePriceTag(selection, sendResponse);\n                    return false;\n                }\n            case \"PRICE_TAG.HIGHLIGHT.START\":\n                elementToHighlight = document.body.querySelector(selection);\n                if (elementToHighlight) {\n                    const originalBackgroundColor = elementToHighlight.style.backgroundColor;\n                    elementToHighlight.style.backgroundColor = \"#c9ecfc\";\n                    sendResponse({status: 1, isHighlighted: true, originalBackgroundColor});\n                } else {\n                    sendResponse({status: -1});\n                }\n                break;\n            case \"PRICE_TAG.HIGHLIGHT.STOP\":\n                originalBackgroundColor = originalBackgroundColor || \"\";\n                elementToStopHighlight = document.body.querySelector(selection);\n                if (elementToStopHighlight) {\n                    elementToStopHighlight.style.backgroundColor = originalBackgroundColor;\n                    sendResponse({status: 1, isHighlighted: false});\n                } else {\n                    sendResponse({status: -1});\n                }\n                break;\n            case \"CONFIRMATION_DISPLAY.CREATE\":\n                return displaySaveConfirmation(elementId, sendResponse);\n            case \"CONFIRMATION_DISPLAY.REMOVE\":\n                confirmationModal = document.getElementById(elementId);\n                if (confirmationModal) {\n                    confirmationModal.remove();\n                }\n                break;\n            default:\n                break;\n        }\n    });\n}\n\nfunction bootstrap() {\n    attachEvents();\n}\n\nbootstrap();\n"],"names":["buildElementSelection","path","maxElements","pathSelection","elemCount","localName","className","id","pathElementSelection","trim","replace","push","reverse","join","getFaviconPath","nodeList","document","getElementsByTagName","node","getAttribute","getFaviconURL","faviconPath","startsWith","location","protocol","hostname","href","evaluatePriceTag","selection","sendResponse","target","body","querySelector","textContent","textContentMatch","match","price","status","faviconURL","faviconAlt","title","displaySaveConfirmation","elementId","extensionOrigin","chrome","runtime","ancestorOrigins","contains","modalElement","createElement","setAttribute","src","getURL","onload","style","cssText","appendChild","attachEvents","onMessage","addListener","type","payload","sender","originalBGColor","elementToHighlight","elementToStopHighlight","confirmationModal","originalBackgroundColor","cursor","window","focus","onclick","event","preventDefault","stopPropagation","url","backgroundColor","onmouseover","addEventListener","removeEventListener","readyState","isHighlighted","getElementById","remove","bootstrap"],"mappings":"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"}