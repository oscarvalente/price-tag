{"version":3,"file":"page-agent.js","sources":["../page-agent.js"],"sourcesContent":["function buildElementSelection(path, maxElements) {\n    const pathSelection = [];\n    let elemCount = 1;\n    for (let {localName, className, id} of path) {\n        if (maxElements >= elemCount) {\n            const pathElementSelection = className ?\n                `${localName.trim()}.${className.trim().replace(/\\s/g, \".\")}` :\n                id ?\n                    `${localName.trim()}#${id}` :\n                    localName.trim();\n            pathSelection.push(pathElementSelection);\n        } else {\n            break;\n        }\n        elemCount++;\n    }\n    return pathSelection.reverse().join(\" \");\n}\n\nfunction getFaviconPath() {\n    const nodeList = document.getElementsByTagName(\"link\");\n    for (let node of nodeList) {\n        if (node.getAttribute(\"rel\") === \"icon\" || node.getAttribute(\"rel\") === \"shortcut icon\") {\n            return node.getAttribute(\"href\");\n        }\n    }\n    return null;\n}\n\nfunction getFaviconURL() {\n    const faviconPath = getFaviconPath();\n    if (faviconPath) {\n        if (faviconPath.startsWith(location.protocol) || faviconPath.startsWith(\"//\")) {\n            return faviconPath;\n        } else if (faviconPath.startsWith(\"/\")) {\n            return `${location.protocol}//${location.hostname}${faviconPath}`;\n        } else {\n            return `${location.href}/${faviconPath}`;\n        }\n    }\n    return null;\n}\n\nfunction evaluatePriceTag(selection, sendResponse) {\n    const target = document.body.querySelector(selection);\n    const textContent = target ? target.textContent : null;\n    if (textContent) {\n        const textContentMatch = textContent.match(/((?:\\d+[.,])?\\d+(?:[.,]\\d+)?)/);\n        if (textContentMatch) {\n            const [, price] = textContentMatch;\n            sendResponse({\n                status: 1,\n                selection,\n                price,\n                faviconURL: getFaviconURL(),\n                faviconAlt: document.title\n            });\n        } else {\n            sendResponse({status: -2});\n        }\n    } else {\n        sendResponse({status: -1});\n    }\n}\n\nfunction displaySaveConfirmation(elementId, sendResponse) {\n    const extensionOrigin = `chrome-extension://${chrome.runtime.id}`;\n    if (!location.ancestorOrigins.contains(extensionOrigin)) {\n        const modalElement = document.createElement(\"iframe\");\n        if (elementId) {\n            modalElement.setAttribute(\"id\", elementId);\n        }\n\n        // Must be declared at web_accessible_resources in manifest.json\n        modalElement.src = chrome.runtime.getURL(\"views/modal.html\");\n        modalElement.onload = () => {\n            sendResponse({status: 1});\n        };\n\n        modalElement.style.cssText = \"position:fixed;top:0;right:0;display:block;\" +\n            \"width:700px;height:100%;z-index:1000;border:0;margin-top: 200px;\";\n\n        document.body.appendChild(modalElement);\n\n        return true;\n    }\n\n    sendResponse({status: -1});\n\n    return false;\n}\n\nfunction attachEvents() {\n    chrome.runtime.onMessage.addListener(({type, payload = {}}, sender, sendResponse) => {\n        const {selection} = payload;\n        switch (type) {\n            case \"RECORD.START\":\n                let originalBGColor;\n\n                document.body.style.cursor = \"pointer\";\n                window.focus();\n                document.body.onclick = function (event) {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    const {target, path} = event;\n                    const {url} = payload;\n                    const {textContent} = target;\n                    const selection = buildElementSelection(path, 3);\n                    let price = null;\n                    if (!url) {\n                        sendResponse({status: -1});\n                        return;\n                    }\n                    if (textContent) {\n                        const textContentMatch = textContent.match(/((?:\\d+[.,])?\\d+(?:[.,]\\d+)?)/);\n                        if (textContentMatch) {\n                            [, price] = textContentMatch;\n                            sendResponse({\n                                status: 1,\n                                url,\n                                selection,\n                                price,\n                                faviconURL: getFaviconURL(),\n                                faviconAlt: document.title\n                            });\n                        } else {\n                            sendResponse({status: -3});\n                        }\n                    } else {\n                        sendResponse({status: -2});\n                    }\n\n                    target.style.backgroundColor = originalBGColor;\n                    document.body.style.cursor = \"\";\n                    document.body.onclick = null;\n                    document.body.onmouseover = null;\n                };\n\n                document.body.onmouseover = ({target}) => {\n                    target.addEventListener(\"mouseout\", ({target}) => {\n                        target.style.backgroundColor = originalBGColor;\n                        target.removeEventListener(\"mouseout\", target);\n                    });\n                    originalBGColor = target.style.backgroundColor;\n                    target.style.backgroundColor = \"#c9ecfc\";\n                };\n\n                return true;\n            case \"RECORD.CANCEL\":\n                document.body.style.cursor = \"\";\n                document.body.onclick = null;\n                document.body.onmouseover = null;\n\n                sendResponse({});\n                break;\n            case \"AUTO_SAVE.CHECK_STATUS\":\n                if (document.readyState !== \"complete\") {\n                    window.onload = () => {\n                        evaluatePriceTag(selection, sendResponse);\n\n                        window.onload = null;\n                    };\n\n                    return true;\n                } else {\n                    evaluatePriceTag(selection, sendResponse);\n                    return false;\n                }\n            case \"PRICE_UPDATE.CHECK_STATUS\":\n                if (document.readyState !== \"complete\") {\n                    window.onload = () => {\n                        evaluatePriceTag(selection, sendResponse);\n\n                        window.onload = null;\n                    };\n\n                    return true;\n                } else {\n                    evaluatePriceTag(selection, sendResponse);\n                    return false;\n                }\n            case \"PRICE_TAG.HIGHLIGHT.START\":\n                const {selection: elementSelection} = payload;\n                const elementToHighlight = document.body.querySelector(elementSelection);\n                if (elementToHighlight) {\n                    const originalBackgroundColor = elementToHighlight.style.backgroundColor;\n                    elementToHighlight.style.backgroundColor = \"#c9ecfc\";\n                    sendResponse({status: 1, isHighlighted: true, originalBackgroundColor});\n                } else {\n                    sendResponse({status: -1});\n                }\n                break;\n            case \"PRICE_TAG.HIGHLIGHT.STOP\":\n                const {selection: elementHighlighted} = payload;\n                let {originalBackgroundColor} = payload;\n                originalBackgroundColor = originalBackgroundColor || \"\";\n                const elementToStopHighlight = document.body.querySelector(elementHighlighted);\n                if (elementToStopHighlight) {\n                    elementToStopHighlight.style.backgroundColor = originalBackgroundColor;\n                    sendResponse({status: 1, isHighlighted: false});\n                } else {\n                    sendResponse({status: -1});\n                }\n                break;\n            case \"CONFIRMATION_DISPLAY.CREATE\":\n                const {elementId: idToCreate} = payload;\n                return displaySaveConfirmation(idToCreate, sendResponse);\n            case \"CONFIRMATION_DISPLAY.REMOVE\":\n                const {elementId: idToRemove} = payload;\n                const confirmationModal = document.getElementById(idToRemove);\n                if (confirmationModal) {\n                    confirmationModal.remove();\n                }\n                break;\n            default:\n                break;\n        }\n    });\n}\n\nfunction bootstrap() {\n    attachEvents();\n}\n\nbootstrap();\n"],"names":["getFaviconURL","faviconPath","nodeList","document","getElementsByTagName","node","getAttribute","getFaviconPath","startsWith","location","protocol","hostname","href","evaluatePriceTag","selection","sendResponse","target","body","querySelector","textContent","textContentMatch","match","price","status","faviconURL","faviconAlt","title","attachEvents","chrome","runtime","onMessage","addListener","type","payload","sender","originalBGColor","style","cursor","window","focus","onclick","event","preventDefault","stopPropagation","path","url","maxElements","pathSelection","elemCount","localName","className","id","pathElementSelection","trim","replace","push","reverse","join","buildElementSelection","backgroundColor","onmouseover","addEventListener","removeEventListener","readyState","onload","elementSelection","elementToHighlight","originalBackgroundColor","isHighlighted","elementHighlighted","elementToStopHighlight","elementId","idToCreate","extensionOrigin","ancestorOrigins","contains","modalElement","createElement","setAttribute","src","getURL","cssText","appendChild","displaySaveConfirmation","idToRemove","confirmationModal","getElementById","remove"],"mappings":"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"}