!function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{},r=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),r.forEach(function(n){e(t,n,o[n])})}return t}var n={TIME:function({timestamp:e},{timestamp:t}){return e-t},CURRENT_PRICE:function({currentPrice:e},{currentPrice:t}){return e-t}};const o="TIME";var r=Object.freeze({TIME:o,CURRENT_PRICE:"CURRENT_PRICE"});let s={recordActive:!1,notifications:{},notificationsCounter:0,autoSaveEnabled:!1,isPriceUpdateEnabled:!1,selection:null,isSimilarElementHighlighted:!1,originalBackgroundColor:null,isCurrentPageTracked:!1,faviconURL:null,_faviconURLMap:{},currentURL:null,canonicalURL:null,browserURL:null,domain:null,_sortItemsBy:o};const i="assets/icon_48.png",c="assets/icon_active_48.png",a="Price Tag",l="Price Tag - This item is being tracked",u=18e4,f=12e4,E={PRICE_UPDATE:"./assets/time-is-money.svg",PRICE_NOT_FOUND:"./assets/time.svg",PRICE_FIX:"./assets/coin.svg"},g={PRICE:/((?:\d+[.,])?\d+(?:[.,]\d+)?)/,HOSTNAME:/https?:\/\/([\w.]+)\/*/,DOMAIN:/^([\w-]+\.)+[\w-]+\w$/,URL:/^https?:\/\/([\w-]+\.)+[\w-]+\w(\/[\w-=.]+)+\/?(\?([\w]+=?[\w-%!@()\\["#\]]+&?)*)?/,CAPTURE:{DOMAIN_IN_URL:/https?:\/\/([\w.]+)\/*/,HOSTNAME_AND_PATH:/^https?:\/\/((?:[\w-]+\.)+[\w-]+\w(?:\/[\w-=.]+)+\/?)/,PROTOCOL_HOSTNAME_AND_PATH:/^(https?:\/\/(?:[\w-]+\.)+[\w-]+\w(?:\/[\w-=.]+)+\/?)/}},d={WATCHED:"WATCHED",NOT_FOUND:"NOT_FOUND",INCREASED:"INCREASED",DECREASED:"DECREASED",ACK_DECREASE:"ACK_DECREASE",ACK_INCREASE:"ACK_INCREASE",FIXED:"FIXED"},h=Object.values(d);function R(e,n){return m(t({},e,{previousPrice:e.currentPrice,currentPrice:n}))}function m(e){const t=100*Math.abs(e.currentPrice-e.price)/e.price,n=parseFloat(t.toFixed(2));let o=null;return n&&((o=e.currentPrice>e.price?+n:-n)>0&&o<1?o=Math.ceil(o):o>-1&&o<0&&(o=Math.floor(o))),e.diffPercentage=o,e}function p(e,n,o,r,s=!1){o||(o=[]),r||(r=[]);const i=(c=[...function(e,t=[]){return t.length>0&&e.statuses.length>0?e.statuses.filter(e=>!t.includes(e)):e.statuses}(e,r),...o],Array.from(new Set(c)));var c;const a=t({},e,{statuses:i,lastUpdateTimestamp:(new Date).getTime()});return s&&(a.startingPrice=e.price),n&&(a.price=n),a}function A(e){return e.statuses.includes(d.WATCHED)}function T(e){return e.statuses.includes(d.NOT_FOUND)}function C(e){return e.statuses.includes(d.ACK_DECREASE)}function S(e){return e.statuses.includes(d.ACK_INCREASE)}function O(e,t,n,o,r,i,c,a){chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.CREATE",payload:{elementId:"price-tag--url-confirmation"}},({status:n})=>{if(1===n){const n=function(e,t,n){return{title:"This website recommends to follow this item through a different URL",message:`<u>${n}</u> says that a more accurate URL for this item would be:<br>`+`<i><a href="${e}" target="_blank"  rel="noopener noreferrer">${e}</a></i><br>`+"If this is correct, we recommend you to follow it.<br><br><b>However</b> you can still opt to choose following the current browser URL:<br>"+`<i><a href="${t}" target="_blank" rel="noopener noreferrer">${t}</a></i><br><br>`+"Since your choice will affect the way items are tracked in this site futurely,<br>please help us helping you by choosing carefully one of the following options:",buttons:["Use recommended URL. Remember this option for this site","Use recommended URL but just this time","It's not correct, use the current browser URL. Remember this option","Don't use recommended URL. Use the current browser URL instead but just this time"]}}(s.canonicalURL,s.browserURL,t);chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.LOAD",payload:n},({status:n,index:o})=>{if(chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.REMOVE",payload:{elementId:"price-tag--url-confirmation"}}),1===n)switch(o){case 0:chrome.storage.local.get([t],e=>{const n=e&&e[t]&&JSON.parse(e[t])||{};n._canUseCanonical=!0,chrome.storage.local.set({[t]:JSON.stringify(n)}),s=y(s,s.canonicalURL),a(!0,!0)});break;case 1:s=y(s,s.canonicalURL),a(!0,!0);break;case 2:chrome.storage.local.get([t],e=>{const n=e&&e[t]&&JSON.parse(e[t])||{};n._canUseCanonical=!1,chrome.storage.local.set({[t]:JSON.stringify(n)}),s=y(s,s.browserURL),a(!0,!1)});break;case 3:s=y(s,s.browserURL),a(!0,!1);break;default:a(!1)}})}})}function b(){s=P(s)}function U(e,{status:t,url:n,domain:o,selection:r,price:i,faviconURL:c,faviconAlt:a}={}){t>=0?(s=K(s=w(s,s.faviconURL||c),r,i,s.faviconURL,a),e(!0)):e(!1)}function N({status:e,isHighlighted:n,originalBackgroundColor:o=null}){e>=0&&(s=function(e,n,o){return t({},e,{isSimilarElementHighlighted:n,originalBackgroundColor:o})}(s,n,o))}function I(e,t,n,o,r,i,c,a){chrome.storage.local.get([e],l=>{const u=l&&l[e]?JSON.parse(l[e]):{};u[t]=function(e,t,n,o,r,s){n||(n=null);const i=x(t);return{selection:e,price:i,currentPrice:i,startingPrice:i,previousPrice:n,faviconURL:o,faviconAlt:r,timestamp:(new Date).getTime(),statuses:s}}(n,o,void 0,r,i,c),chrome.storage.local.set({[e]:JSON.stringify(u)},()=>{s=F(s),a&&a()})})}function P(e){return t({},e,{recordActive:!1})}function _(e){return t({},e,{isCurrentPageTracked:!1})}function D(e){return t({},e,{isCurrentPageTracked:!0})}function y(e,n){return t({},e,{currentURL:n})}function L(e,n){return t({},e,{canonicalURL:n})}function v(e,n){return t({},e,{browserURL:n})}function w(e,n){return t({},e,{faviconURL:n})}function H(e,n){return t({},e,{_sortItemsBy:n})}function k(e,t,n){chrome.storage.local.get([t],o=>{const r=o&&o[t]&&JSON.parse(o[t])||null,s=!r||void 0===r._canUseCanonical;n(s&&!!e.canonicalURL&&e.canonicalURL!==e.browserURL)})}function M(){chrome.browserAction.setTitle({title:a}),chrome.browserAction.setIcon({path:i})}function J(){chrome.browserAction.setTitle({title:l}),chrome.browserAction.setIcon({path:c})}function F(e){return t({},e,{autoSaveEnabled:!1})}function G(e){return t({},e,{isPriceUpdateEnabled:!1})}function K(e,n,o,r,s){return t({},e,{selection:n,price:o,faviconURL:r,faviconAlt:s})}function $(){chrome.storage.local.get(null,e=>{for(let t in e)if(e.hasOwnProperty(t)&&V(t)){const n=JSON.parse(e[t]);for(let e in n)if(n.hasOwnProperty(e)&&Y(e)&&A(n[e])){const o=new XMLHttpRequest,{price:r,currentPrice:i}=n[e];o.onload=function(){const o=X(this.response);try{let c=null;const a=o.querySelector(n[e].selection).textContent;if(a){const o=a.match(g.PRICE);if(o)if([,c]=o,c=x(c),r)if(c<i){const o=R(n[e],c);n[e]=p(o,null,[d.DECREASED],[d.INCREASED,d.NOT_FOUND,d.ACK_DECREASE]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{if(c<r&&!C(n[e])){W(`TRACK.PRICE_UPDATE-${s.notificationsCounter}`,E.PRICE_UPDATE,"Lower price!!",`${c} (previous ${r})`,e,e,t,d.DECREASED,{buttons:[{title:`Keep tracking but w/ new price (${c})`},{title:"Stop watching"}]})}})}else if(c>i){const o=R(n[e],c);n[e]=p(o,null,[d.INCREASED],[d.DECREASED,d.NOT_FOUND,d.ACK_INCREASE]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{if(!S(n[e])){const o=`TRACK.PRICE_UPDATE-${s.notificationsCounter}`,r=n[e].price!==n[e].previousPrice?{buttons:[{title:`Increase interest price to the previous (${n[e].previousPrice})`}]}:{buttons:[]};r.buttons.push({title:"Stop watching"}),W(o,E.PRICE_UPDATE,"Price increase",`${c} (previous ${n[e].previousPrice})`,e,e,t,d.INCREASED,r)}})}else T(n[e])?(n[e]=p(n[e],null,null,[d.NOT_FOUND]),chrome.storage.local.set({[t]:JSON.stringify(n)})):(n[e]=p(n[e],null,null,[d.NOT_FOUND]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{}));else n[e]=p(n[e],c,[d.FIXED],[d.NOT_FOUND]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{W(`TRACK.PRICE_FIXED-${s.notificationsCounter}`,E.PRICE_FIX,"Fixed price",`Ermm.. We've just fixed a wrongly set price to ${c}`,e,e,t)})}n[e].price&&!c&&(T(n[e])||(n[e]=p(n[e],null,[d.NOT_FOUND],[d.DECREASED,d.INCREASED,d.FIXED,d.ACK_DECREASE]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{const n=`TRACK.PRICE_NOT_FOUND-${s.notificationsCounter}`,o=r?` (previous ${r})`:"";W(n,E.PRICE_NOT_FOUND,"Price gone",`Price tag no longer found${o}`,e,e,t)})))}catch(o){T(n[e])||(console.warn(`Invalid price selection element in\n${e}:\t"${n[e].selection}"`),n[e]=p(n[e],null,[d.NOT_FOUND],[d.DECREASED,d.INCREASED,d.FIXED,d.ACK_DECREASE]),chrome.storage.local.set({[t]:JSON.stringify(n)},()=>{const n=`TRACK.PRICE_NOT_FOUND-${s.notificationsCounter}`,o=r?` (previous ${r})`:"";W(n,E.PRICE_NOT_FOUND,"Price gone",`Price tag no longer found${o}`,e,e,t)}))}},o.open("GET",e),o.send()}}})}function j(e,o){chrome.storage.local.get(null,r=>{let s=[];Object.keys(r).forEach(e=>{if(V(e)){const n=r[e],o=JSON.parse(n)||null;if(o){let e=[];Object.keys(o).forEach(n=>{if(function(e){return g.HOSTNAME.test(e)}(n)&&A(o[n])){const r=t({},o[n],{url:n});e.push(r)}}),s=[...s,...e]}}});const i=n[e];s.sort(i),o(s)})}function B(e,n){chrome.notifications.clear(e,o=>{if(o||n){const{domain:t,url:n,type:o}=s.notifications[e];chrome.storage.local.get([t],e=>{const r=e&&e[t]?JSON.parse(e[t]):null;switch(o){case d.DECREASED:r[n]=p(r[n],null,[d.ACK_DECREASE]);break;case d.INCREASED:r[n]=p(r[n],null,[d.ACK_INCREASE])}chrome.storage.local.set({[t]:JSON.stringify(r)})})}s=function(e,n){const o=t({},e);return delete o.notifications[n],o}(s,e)})}function W(e,n,o,r,i="",c,a,l,u={}){const f=t({type:"basic",title:o,message:r,iconUrl:n,contextMessage:i,requireInteraction:!0},u);var E;chrome.notifications.create(e,f,e=>{s=function(e,n,o){return t({},e,{notifications:t({},e.notifications,{[n]:o})})}(s,e,{url:c,domain:a,type:l})}),s=t({},E=s,{notificationsCounter:E.notificationsCounter+1})}function x(e){const t=parseFloat(e.replace(",",".")).toFixed(2);return parseFloat(t)}function X(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content}function q(e){return e&&(t=e,g.CAPTURE.HOSTNAME_AND_PATH.test(t));var t}function V(e){return g.DOMAIN.test(e)}function Y(e){return g.URL.test(e)}function z(e,n){chrome.storage.local.get([n],o=>{const r=o&&o[n]?JSON.parse(o[n]):{},i=!r[e]||!A(r[e]);if(r&&i){const e=Object.keys(r)[0];r[e]&&r[e].selection&&(s=function(e,n){return t({},e,{autoSaveEnabled:!0,selection:n=n||e.selection})}(s,r[e].selection))}else s=F(s)})}function Q(e,n){chrome.storage.local.get([n],o=>{const r=(o&&o[n]?JSON.parse(o[n]):{})[e],i=r&&r.price!==r.currentPrice;s=i?function(e,n){return t({},e,{isPriceUpdateEnabled:!0,selection:n})}(s,r.selection):G(s)})}function Z(e,t,n,o){!0===n?(J(),s=D(s)):!1===n?(M(),s=_(s)):n||chrome.storage.local.get([e],n=>{const r=function(e,t){return e&&e[t]&&JSON.parse(e[t])||null}(n,e);if(r){const e=r[t]||r[o];e&&A(e)?(J(),s=D(s)):(M(),s=_(s))}else M(),s=_(s)})}function ee(e){const t=e.match(g.CAPTURE.HOSTNAME_AND_PATH);let n=null;return t&&([,n]=t),n}function te(e){const t=e.match(g.CAPTURE.PROTOCOL_HOSTNAME_AND_PATH);let n=null;return t&&([,n]=t),n}function ne(e,t,n){const o=ee(t);for(let r in e)if(e.hasOwnProperty(r)&&Y(r)&&A(e[r])){if(t===r)return void n(null);if(ee(r)===o)return void n(r)}n(null)}function oe(e,t,n,o){chrome.storage.local.get([t],r=>{const s=r&&r[t]&&JSON.parse(r[t])||null;s?!0===s._isPathEnoughToTrack?ne(s,n,e=>{e?o(!1,!1):o(!0)}):!1===s._isPathEnoughToTrack?o(!0):ne(s,n,r=>{if(r){const i="price-tag--save-confirmation";chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.CREATE",payload:{elementId:i}},({status:c})=>{if(1===c){const c=function(e,t){return{title:"Item with similar URL to existing one",message:"It appears that the item URL you're trying to save:<br>"+`<i><a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a></i><br>`+"is pretty similar to<br>"+`<i><a href="${t}" target="_blank" rel="noopener noreferrer">${t}</a></i><br><br>`+"Since your choice will affect the way items are tracked in this site futurely,<br>please help us helping you by choosing carefully one of the following options:",buttons:["It's not, save it! Remember this option for this site.","Don't save. Ask me again for items of this site!","Indeed the same item. Don't save! Remember this option for this site. (Use just URL path for accessing items)","For now save this item. Ask me again next time!"]}}(n,r);chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.LOAD",payload:c},({status:n,index:r})=>{if(chrome.tabs.sendMessage(e,{type:"CONFIRMATION_DISPLAY.REMOVE",payload:{elementId:i}}),1===n)switch(r){case 0:s._isPathEnoughToTrack=!1,chrome.storage.local.set({[t]:JSON.stringify(s)}),o(!0);break;case 1:o(!1,!0);break;case 2:s._isPathEnoughToTrack=!0,chrome.storage.local.set({[t]:JSON.stringify(s)}),o(!1,!1);break;case 3:o(!0);break;default:o(!1,!0)}else o(!1,!0)})}else o(!1,!0)})}else o(!0)}):o(!0)})}function re(e,n){const o=n.match(g.CAPTURE.DOMAIN_IN_URL);if(o){const[,e]=o;s=function(e,n){return t({},e,{domain:n})}(s,e),chrome.storage.local.get([e],t=>{const o=t&&t[e]&&JSON.parse(t[e])||null;if(o&&!1===o._canUseCanonical){if(s=v(s=y(s=L(s,null),n),n),!0===o._isPathEnoughToTrack){const e=te(n);e&&(s=v(s=y(s,e),e))}z(s.currentURL,s.domain),Q(s.currentURL,s.domain),Z(s.domain,s.currentURL,null,n)}else s=v(s,n),function(e,t){const n=new XMLHttpRequest;n.onload=function(){const e=X(this.response);t(e)},n.open("GET",e),n.send()}(n,e=>{const t=function(e){const t=e.querySelector('link[rel="canonical"]');return t&&t.getAttribute("href")}(e);if(q(t))s=L(s=y(s,t),t);else if(s=y(s=L(s,null),n),o&&!0===o._isPathEnoughToTrack){const e=te(n);e&&(s=v(s=y(s,e),e))}z(s.currentURL,s.domain),Q(s.currentURL,s.domain),Z(s.domain,s.currentURL,null,n)})})}}function se(){chrome.runtime.onInstalled.addListener(()=>{console.log("Price tag installed.")}),chrome.tabs.onActivated.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},([{id:e,url:t}])=>{t.startsWith("http")?(re(0,t),s=w(s,s._faviconURLMap[e]||null)):M()})}),chrome.tabs.onUpdated.addListener((e,{status:n,favIconUrl:o},{active:r,url:i})=>{i.startsWith("http")?r&&o&&(s=w(s=function(e,n,o){return t({},e,{_faviconURLMap:t({},e._faviconURLMap,{[n]:o})})}(s,e,o),o)):M()}),chrome.webNavigation.onCompleted.addListener(({frameId:e})=>{0===e&&chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(e.length>0){const[{id:t,url:n}]=e;re(0,n)}})}),chrome.webNavigation.onHistoryStateUpdated.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(e.length>0){const[{id:t,url:n}]=e;void 0!==n&&n!==s.browserURL&&re(0,n)}})}),chrome.runtime.onMessage.addListener(({type:e,payload:n={}},i,c)=>{const{id:a}=n;switch(e){case"POPUP.STATUS":const{recordActive:i,autoSaveEnabled:l,isPriceUpdateEnabled:u}=s;c({status:1,state:{recordActive:i,autoSaveEnabled:l,isPriceUpdateEnabled:u}});break;case"RECORD.ATTEMPT":if((s=function(e){return t({},e,{recordActive:!e.recordActive})}(s)).recordActive){const{url:e}=n;chrome.tabs.sendMessage(a,{type:"RECORD.START",payload:{url:e}},function(e,t){const{status:n,selection:o,price:r,faviconURL:i,faviconAlt:c}=t,{currentURL:a,domain:l}=s;n>0&&(k(s=w(s,s.faviconURL||i),l,t=>{t?O(e,l,0,0,0,0,0,(t,n)=>{if(t){const t=n?s.canonicalURL:s.browserURL;oe(e,l,t,e=>{e&&(I(l,t,o,r,s.faviconURL,c,[d.WATCHED]),Z(l,t,!0))})}}):oe(e,l,a,e=>{e&&(I(l,a,o,r,s.faviconURL,c,[d.WATCHED]),Z(l,a,!0))})}),s=P(s))}.bind(null,a))}else chrome.tabs.sendMessage(a,{type:"RECORD.CANCEL"},b);c({status:1,state:{recordActive:s.recordActive}});break;case"AUTO_SAVE.STATUS":const{currentURL:f,domain:E}=s;return chrome.storage.local.get([E],e=>{const t=e&&e[E]&&JSON.parse(e[E])||null;t&&!0===t._isPathEnoughToTrack?ne(t,f,e=>{e?c({status:-1}):chrome.tabs.sendMessage(a,{type:"AUTO_SAVE.CHECK_STATUS",payload:{url:f,selection:s.selection}},U.bind(null,c))}):chrome.tabs.sendMessage(a,{type:"AUTO_SAVE.CHECK_STATUS",payload:{url:f,selection:s.selection}},U.bind(null,c))}),!0;case"AUTO_SAVE.ATTEMPT":if(s.autoSaveEnabled){const{domain:e,currentURL:t,selection:n,price:o,faviconURL:r,faviconAlt:i,originalBackgroundColor:l}=s;return k(s,e,u=>{u?O(a,e,0,0,0,0,0,(t,u)=>{if(t){const t=u?s.canonicalURL:s.browserURL;oe(a,e,t,(u,f)=>{u?I(e,t,n,o,r,i,[d.WATCHED],()=>{chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.STOP",payload:{selection:n,originalBackgroundColor:l}},N),Z(e,t,!0),s=F(s),c(!1)}):f||(s=F(s))})}}):oe(a,e,t,u=>{u&&I(e,t,n,o,r,i,[d.WATCHED],()=>{chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.STOP",payload:{selection:n,originalBackgroundColor:l}},N),Z(e,t,!0),s=F(s),c(!1)})})}),!0}c(!1);break;case"AUTO_SAVE.HIGHLIGHT.PRE_START":if(s.autoSaveEnabled){const{selection:e}=s;chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.START",payload:{selection:e}},N)}break;case"AUTO_SAVE.HIGHLIGHT.PRE_STOP":if(s.autoSaveEnabled){const{selection:e,originalBackgroundColor:t}=s;chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.STOP",payload:{selection:e,originalBackgroundColor:t}},N)}break;case"PRICE_UPDATE.STATUS":return chrome.storage.local.get([s.domain],e=>{const t=(e&&e[s.domain]?JSON.parse(e[s.domain]):{})[s.currentURL];t?chrome.tabs.sendMessage(a,{type:"PRICE_UPDATE.CHECK_STATUS",payload:{selection:s.selection}},function(e,t,{status:n,selection:o,price:r,faviconURL:i,faviconAlt:c}={}){n>=0&&(s=K(s=w(s,s.faviconURL||i),o,r,s.faviconURL,c),x(r)!==t)?e(!0):e(!1)}.bind(null,c,t.price)):c(!1)}),!0;case"PRICE_UPDATE.ATTEMPT":if(s.isPriceUpdateEnabled){const{domain:e,currentURL:t,selection:n,price:o,originalBackgroundColor:r}=s,i=o&&x(o);chrome.storage.local.get([e],o=>{const l=o&&o[e]?JSON.parse(o[e]):{};l[t]=p(l[t],i,null,[d.INCREASED,d.ACK_INCREASE,d.DECREASED,d.INCREASED,d.DECREASED,d.ACK_DECREASE,d.DECREASED,d.DECREASED,d.NOT_FOUND]),l[t]=m(l[t]),chrome.storage.local.set({[e]:JSON.stringify(l)}),chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.STOP",payload:{selection:n,originalBackgroundColor:r}},N),s=G(s),c(!1)})}return!0;case"PRICE_UPDATE.HIGHLIGHT.PRE_START":if(s.isPriceUpdateEnabled){const{selection:e}=s;chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.START",payload:{selection:e}},N)}break;case"PRICE_UPDATE.HIGHLIGHT.PRE_STOP":if(s.isPriceUpdateEnabled){const{selection:e,originalBackgroundColor:t}=s;chrome.tabs.sendMessage(a,{type:"PRICE_TAG.HIGHLIGHT.STOP",payload:{selection:e,originalBackgroundColor:t}},N)}break;case"TRACKED_ITEMS.OPEN":s=H(s,o);break;case"TRACKED_ITEMS.GET":return j(s._sortItemsBy,c),!0;case"TRACKED_ITEMS.UNFOLLOW":const{url:g}=n;return function(e,t,n){let o=!1;chrome.storage.local.get(null,r=>{Object.keys(r).forEach(s=>{if(V(s)){const i=r[s],c=JSON.parse(i)||null;c[e]&&(o=!0,c[e]=p(c[e],null,null,h),chrome.storage.local.set({[s]:JSON.stringify(c)},()=>{t===e&&(z(e,s),Q(e,s),Z(s,e,!1)),n(!0)}))}}),o||n(!1)})}(g,s.currentURL,c),!0;case"TRACKED_ITEMS.CHANGE_SORT":const{sortByType:R}=n;s=H(s,r[R])}}),chrome.notifications.onClicked.addListener(e=>{chrome.tabs.create({url:s.notifications[e].url}),B(e)}),chrome.notifications.onButtonClicked.addListener((e,t)=>{const{domain:n,url:o,type:r}=s.notifications[e];switch(t){case 0:switch(r){case d.DECREASED:chrome.storage.local.get([n],e=>{const t=e&&e[n]?JSON.parse(e[n]):{};if(t[o]){const{price:e}=t[o];t[o]=p(t[o],e,null,[d.DECREASED,d.ACK_DECREASE],!0),chrome.storage.local.set({[n]:JSON.stringify(t)})}});break;case d.INCREASED:chrome.storage.local.get([n],e=>{const t=e&&e[n]?JSON.parse(e[n]):{};if(t[o]){const{previousPrice:e}=t[o];t[o]=p(t[o],e,null,[d.INCREASED,d.ACK_INCREASE],!0),chrome.storage.local.set({[n]:JSON.stringify(t)})}})}break;case 1:switch(r){case d.INCREASED:chrome.storage.local.get([n],e=>{const t=e&&e[n]?JSON.parse(e[n]):{};t[o]&&(t[o]=p(t[o],null,null,h),chrome.storage.local.set({[n]:JSON.stringify(t)}))})}}}),chrome.notifications.onClosed.addListener(B)}function ie(e){let n={};for(let o in e)if(e.hasOwnProperty(o)&&V(o)&&e[o]){n=t({},n,{[o]:JSON.parse(e[o])})}return n}function ce(e){return Object.keys(e).reduce((n,o)=>t({},n,{[o]:JSON.stringify(e[o])}),{})}function ae(){chrome.storage.local.get(null,e=>{const t=ie(e);chrome.storage.sync.get(null,e=>{const n=ie(e),o=JSON.parse(JSON.stringify(t));for(let e in n)if(n.hasOwnProperty(e)&&V(e)){const t=n[e];if(o[e]){for(let n in t)if(t.hasOwnProperty(n)){const r=t[n];o[e][n]?r.lastUpdateTimestamp>o[e][n].lastUpdateTimestamp&&(o[e][n]=JSON.parse(JSON.stringify(r))):o[e][n]=Object.assign({},r)}}else o[e]=JSON.parse(JSON.stringify(t))}chrome.storage.local.set(ce(o)),chrome.storage.sync.set(ce(o))})})}ae(),setInterval(ae,f),$(),setInterval($,u),se()}();
